<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYS - Kalite Yönetim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold">KYS</h1>
                <p class="text-gray-600">Kalite Yönetim Sistemi</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Kullanıcı Adı</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Şifre</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                    Giriş Yap
                </button>
            </form>
            
            <div class="mt-4 text-center text-sm text-gray-600">
                Test: admin / Admin123
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold">KYS - Kalite Yönetim Sistemi</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-700"></span>
                        <button onclick="logout()" class="text-sm text-red-600 hover:text-red-900">
                            Çıkış Yap
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showSection('dashboard')" class="nav-item text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        Ana Sayfa
                    </button>
                    <button onclick="showSection('documents')" class="nav-item text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        Dokümanlar
                    </button>
                    <button onclick="showSection('capa')" class="nav-item text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        DÖF/CAPA
                    </button>
                    <button onclick="showSection('audit')" class="nav-item text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        Denetimler
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section">
                <h2 class="text-2xl font-bold mb-6">Ana Sayfa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Toplam Doküman</p>
                                <p class="text-2xl font-semibold" id="totalDocuments">-</p>
                            </div>
                            <i data-lucide="file-text" class="w-8 h-8 text-blue-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Bekleyen İnceleme</p>
                                <p class="text-2xl font-semibold" id="pendingReviews">-</p>
                            </div>
                            <i data-lucide="clock" class="w-8 h-8 text-yellow-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Açık DÖF</p>
                                <p class="text-2xl font-semibold">0</p>
                            </div>
                            <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Planlı Denetim</p>
                                <p class="text-2xl font-semibold">0</p>
                            </div>
                            <i data-lucide="clipboard-check" class="w-8 h-8 text-green-500"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div id="documentsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Doküman Yönetimi</h2>
                    <button onclick="showDocumentForm()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i data-lucide="plus" class="inline-block w-4 h-4 mr-2"></i>
                        Yeni Doküman
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="searchDocuments" placeholder="Doküman ara..." 
                               class="rounded-md border-gray-300 shadow-sm p-2 border">
                        <select id="filterCategory" class="rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Tüm Kategoriler</option>
                        </select>
                        <select id="filterType" class="rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Tüm Tipler</option>
                            <option value="PROSEDÜR">Prosedür</option>
                            <option value="TALİMAT">Talimat</option>
                            <option value="FORM">Form</option>
                            <option value="LİSTE">Liste</option>
                        </select>
                        <button onclick="loadDocuments()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            Filtrele
                        </button>
                    </div>
                </div>

                <!-- Documents Table -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Doküman Kodu
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Doküman Adı
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Kategori
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tip
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Versiyon
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Documents will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CAPA Section -->
            <div id="capaSection" class="section hidden">
                <h2 class="text-2xl font-bold mb-6">Düzeltici ve Önleyici Faaliyetler</h2>
                <div class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-600">DÖF/CAPA modülü yakında eklenecek...</p>
                </div>
            </div>

            <!-- Audit Section -->
            <div id="auditSection" class="section hidden">
                <h2 class="text-2xl font-bold mb-6">Denetim Yönetimi</h2>
                <div class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-600">Denetim modülü yakında eklenecek...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Document Form Modal -->
    <div id="documentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold mb-4">Yeni Doküman Oluştur</h3>
            <form id="documentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Doküman Kodu</label>
                    <input type="text" id="docCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-gray-100" readonly placeholder="Doküman tipi seçildiğinde otomatik oluşacak">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Doküman Adı</label>
                    <input type="text" id="docName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Kategori</label>
                    <select id="docCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Doküman Tipi</label>
                    <select id="docType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required onchange="generateDocumentCode()">
                        <option value="">Seçiniz</option>
                        <option value="PROSEDÜR">Prosedür</option>
                        <option value="TALİMAT">Talimat</option>
                        <option value="FORM">Form</option>
                        <option value="LİSTE">Liste</option>
                        <option value="PLAN">Plan</option>
                        <option value="POLİTİKA">Politika</option>
                        <option value="ŞARTNAME">Şartname</option>
                        <option value="KILAVUZ">Kılavuz</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Açıklama</label>
                    <textarea id="docDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Doküman Dosyası</label>
                    <input type="file" id="newDocumentFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.png,.jpg,.jpeg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Desteklenen: PDF, Word, Excel, Text, Resim (Maks: 10MB)</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeDocumentForm()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        İptal
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API URLs
        const AUTH_API = 'http://localhost:3001';
        const DOC_API = 'http://localhost:3004';
        
        // Global variables
        let currentUser = null;
        let authToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Check if already logged in
            const savedUser = localStorage.getItem('kys_user');
            const savedToken = localStorage.getItem('kys_token');
            
            if (savedUser && savedToken) {
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                showMainApp();
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${AUTH_API}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    authToken = data.tokens.accessToken;
                    
                    localStorage.setItem('kys_user', JSON.stringify(currentUser));
                    localStorage.setItem('kys_token', authToken);
                    
                    showMainApp();
                } else {
                    alert(data.error || 'Giriş başarısız');
                }
            } catch (error) {
                alert('Bağlantı hatası: ' + error.message);
            }
        });

        // Show main app
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `${currentUser.fullName} (${currentUser.username})`;
            
            loadCategories();
            loadDocumentStats();
            showSection('dashboard');
            
            // Recreate icons after showing main app
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Logout
        function logout() {
            localStorage.removeItem('kys_user');
            localStorage.removeItem('kys_token');
            currentUser = null;
            authToken = null;
            
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        // Show section
        function showSection(section, clickedElement = null) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            const sectionElement = document.getElementById(`${section}Section`);
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
            }
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-gray-900', 'text-white');
                item.classList.add('text-gray-300');
            });
            
            // If called from event, use event.target, otherwise find the button
            let targetElement = clickedElement;
            if (typeof event !== 'undefined' && event && event.target) {
                targetElement = event.target;
            }
            
            if (targetElement && targetElement.classList) {
                targetElement.classList.remove('text-gray-300');
                targetElement.classList.add('bg-gray-900', 'text-white');
            }
            
            // Load data for section
            if (section === 'documents') {
                loadDocuments();
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${DOC_API}/api/v1/document-categories`);
                const data = await response.json();
                
                if (data.success) {
                    const categorySelect = document.getElementById('docCategory');
                    const filterSelect = document.getElementById('filterCategory');
                    
                    categorySelect.innerHTML = '<option value="">Seçiniz</option>';
                    filterSelect.innerHTML = '<option value="">Tüm Kategoriler</option>';
                    
                    data.data.forEach(cat => {
                        categorySelect.innerHTML += `<option value="${cat.id}">${cat.categoryName}</option>`;
                        filterSelect.innerHTML += `<option value="${cat.id}">${cat.categoryName}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load document stats
        async function loadDocumentStats() {
            try {
                const response = await fetch(`${DOC_API}/api/v1/documents/stats`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalDocuments').textContent = data.data.totalDocuments;
                    document.getElementById('pendingReviews').textContent = data.data.pendingReviews;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load documents
        async function loadDocuments() {
            try {
                const search = document.getElementById('searchDocuments').value;
                const categoryId = document.getElementById('filterCategory').value;
                const documentType = document.getElementById('filterType').value;
                
                let url = `${DOC_API}/api/v1/documents?`;
                if (search) url += `search=${search}&`;
                if (categoryId) url += `categoryId=${categoryId}&`;
                if (documentType) url += `documentType=${documentType}&`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('documentsTable');
                    tbody.innerHTML = '';
                    
                    data.data.forEach(doc => {
                        tbody.innerHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${doc.documentCode}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${doc.documentName}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${doc.categoryName || '-'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${doc.documentType}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${doc.currentVersion}
                                    ${doc.currentRevision && doc.currentRevision.approvalStatus === 'DRAFT' ? 
                                        '<span class="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">Onay Bekliyor</span>' : 
                                    ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="viewDocument(${doc.id})" class="text-indigo-600 hover:text-indigo-900 mr-2">
                                        Görüntüle
                                    </button>
                                    <button onclick="editDocument(${doc.id})" class="text-green-600 hover:text-green-900">
                                        Düzenle
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    Doküman bulunamadı
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // Show document form
        function showDocumentForm() {
            document.getElementById('documentModal').classList.remove('hidden');
            document.getElementById('documentForm').reset();
            document.getElementById('docCode').value = '';
        }

        // Generate document code when type is selected
        async function generateDocumentCode() {
            const docType = document.getElementById('docType').value;
            const docCodeInput = document.getElementById('docCode');
            
            if (!docType) {
                docCodeInput.value = '';
                return;
            }
            
            try {
                const response = await fetch(`${DOC_API}/api/v1/documents/next-code/${encodeURIComponent(docType)}`);
                const data = await response.json();
                
                if (data.success) {
                    docCodeInput.value = data.data.nextCode;
                } else {
                    console.error('Error generating code:', data.error);
                    docCodeInput.value = 'ERROR';
                }
            } catch (error) {
                console.error('Error generating code:', error);
                docCodeInput.value = 'ERROR';
            }
        }

        // Close document form
        function closeDocumentForm() {
            document.getElementById('documentModal').classList.add('hidden');
        }

        // Create document
        document.getElementById('documentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('newDocumentFile');
            if (!fileInput.files[0]) {
                alert('Lütfen bir dosya seçin');
                return;
            }
            
            // First create the document
            const documentData = {
                documentName: document.getElementById('docName').value,
                categoryId: parseInt(document.getElementById('docCategory').value),
                documentType: document.getElementById('docType').value,
                description: document.getElementById('docDescription').value,
                accessLevel: 'INTERNAL'
            };
            
            try {
                const response = await fetch(`${DOC_API}/api/v1/documents`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(documentData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Now create the first revision with file
                    const formData = new FormData();
                    formData.append('revisionNumber', '1.0');
                    formData.append('revisionReason', 'İlk versiyon');
                    formData.append('changesSummary', 'Doküman oluşturuldu');
                    formData.append('isMajorRevision', 'true');
                    formData.append('documentFile', fileInput.files[0]);
                    
                    const revisionResponse = await fetch(`${DOC_API}/api/v1/documents/${data.data.id}/revisions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    const revisionData = await revisionResponse.json();
                    
                    if (revisionData.success) {
                        // Auto-approve the first revision
                        const approveResponse = await fetch(`${DOC_API}/api/v1/revisions/${revisionData.data.id}/approve`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ comments: 'İlk versiyon otomatik onaylandı' })
                        });
                        
                        if (approveResponse.ok) {
                            alert('Doküman başarıyla oluşturuldu ve dosya yüklendi');
                            closeDocumentForm();
                            loadDocuments();
                            loadDocumentStats();
                        }
                    } else {
                        alert('Dosya yüklenemedi: ' + (revisionData.error || 'Bilinmeyen hata'));
                    }
                } else {
                    alert(data.error || 'Doküman oluşturulamadı');
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // View document details
        async function viewDocument(id) {
            try {
                const response = await fetch(`${DOC_API}/api/v1/documents/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    showDocumentDetails(data.data);
                }
            } catch (error) {
                alert('Doküman yüklenemedi: ' + error.message);
            }
        }

        // Show document details modal
        function showDocumentDetails(doc) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full';
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-8 border w-4/5 max-w-4xl shadow-lg rounded-md bg-white">
                    <h3 class="text-2xl font-bold mb-4">${doc.documentCode} - ${doc.documentName}</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">Kategori</p>
                            <p class="font-medium">${doc.category?.categoryName || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Doküman Tipi</p>
                            <p class="font-medium">${doc.documentType}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Mevcut Versiyon</p>
                            <p class="font-medium">${doc.currentVersion}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Sahibi</p>
                            <p class="font-medium">${doc.owner?.fullName || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">İnceleme Sıklığı</p>
                            <p class="font-medium">${doc.reviewFrequencyMonths} ay</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Sonraki İnceleme</p>
                            <p class="font-medium">${doc.nextReviewDate ? new Date(doc.nextReviewDate).toLocaleDateString('tr-TR') : '-'}</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-2">Açıklama</p>
                        <p class="text-gray-800">${doc.description || 'Açıklama yok'}</p>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-3">Revizyon Geçmişi</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Versiyon</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tarih</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sebep</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Oluşturan</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Durum</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${doc.revisions && doc.revisions.length > 0 ? doc.revisions.map(rev => `
                                        <tr>
                                            <td class="px-4 py-2 text-sm">${rev.revisionNumber}</td>
                                            <td class="px-4 py-2 text-sm">${new Date(rev.revision_date).toLocaleDateString('tr-TR')}</td>
                                            <td class="px-4 py-2 text-sm">${rev.revision_reason || '-'}</td>
                                            <td class="px-4 py-2 text-sm">${rev.users_document_revisions_created_by_user_idTousers?.fullName || '-'}</td>
                                            <td class="px-4 py-2 text-sm">
                                                <span class="px-2 py-1 text-xs rounded-full ${
                                                    rev.approvalStatus === 'APPROVED' ? 'bg-green-100 text-green-800' :
                                                    rev.approvalStatus === 'DRAFT' ? 'bg-gray-100 text-gray-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }">
                                                    ${rev.approvalStatus}
                                                </span>
                                                ${rev.approvalStatus === 'DRAFT' ? `
                                                    <button onclick="approveRevision(${rev.id}, ${doc.id})" class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">
                                                        Onayla
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">Henüz revizyon yok</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <div>
                            ${doc.currentRevision && doc.currentRevision.filePath ? `
                                <button onclick="viewDocumentFile(${doc.id})" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mr-2">
                                    <i data-lucide="eye" class="inline-block w-4 h-4 mr-1"></i>
                                    Görüntüle
                                </button>
                                <button onclick="downloadDocument(${doc.id})" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 mr-2">
                                    <i data-lucide="download" class="inline-block w-4 h-4 mr-1"></i>
                                    İndir
                                </button>
                            ` : ''}
                            <button onclick="showRevisionForm(${doc.id})" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">
                                <i data-lucide="file-plus" class="inline-block w-4 h-4 mr-1"></i>
                                Yeni Revizyon
                            </button>
                            <button onclick="editDocument(${doc.id})" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                <i data-lucide="edit" class="inline-block w-4 h-4 mr-1"></i>
                                Düzenle
                            </button>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            Kapat
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Show revision form
        function showRevisionForm(documentId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-bold mb-4">Yeni Revizyon Oluştur</h3>
                    <form id="revisionForm" onsubmit="createRevision(event, ${documentId})" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Revizyon Numarası</label>
                            <input type="text" id="revisionNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Revizyon Sebebi</label>
                            <textarea id="revisionReason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Değişiklik Özeti</label>
                            <textarea id="changesSummary" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Doküman Dosyası</label>
                            <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.png,.jpg,.jpeg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <p class="text-xs text-gray-500 mt-1">Desteklenen: PDF, Word, Excel, Text, Resim (Maks: 10MB)</p>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="isMajorRevision" class="mr-2">
                                <span class="text-sm">Majör Revizyon</span>
                            </label>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                İptal
                            </button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Oluştur
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Create revision
        async function createRevision(event, documentId) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('revisionNumber', document.getElementById('revisionNumber').value);
            formData.append('revisionReason', document.getElementById('revisionReason').value);
            formData.append('changesSummary', document.getElementById('changesSummary').value);
            formData.append('isMajorRevision', document.getElementById('isMajorRevision').checked);
            
            const fileInput = document.getElementById('documentFile');
            if (fileInput.files[0]) {
                formData.append('documentFile', fileInput.files[0]);
            }
            
            try {
                const response = await fetch(`${DOC_API}/api/v1/documents/${documentId}/revisions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    // HTML error page returned
                    const text = await response.text();
                    console.error('Server error:', text);
                    alert('Sunucu hatası oluştu. Lütfen tekrar deneyin.');
                    return;
                }
                
                if (response.ok && data.success) {
                    alert('Revizyon başarıyla oluşturuldu');
                    document.querySelector('.fixed.z-50').remove();
                    viewDocument(documentId); // Refresh document view
                } else {
                    alert(data.error || 'Revizyon oluşturulamadı');
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }

        // Approve revision
        async function approveRevision(revisionId, documentId) {
            if (!confirm('Bu revizyonu onaylamak istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const response = await fetch(`${DOC_API}/api/v1/revisions/${revisionId}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        comments: 'Doküman incelendi ve onaylandı.' 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Revizyon başarıyla onaylandı!');
                    
                    // Close the current modal
                    document.querySelector('.fixed').remove();
                    
                    // Refresh the document view
                    viewDocument(documentId);
                    
                    // Refresh the documents list
                    loadDocuments();
                } else {
                    alert(data.error || 'Revizyon onaylanamadı');
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }

        // View document file
        function viewDocumentFile(id) {
            window.open(`${DOC_API}/api/v1/documents/${id}/view`, '_blank');
        }

        // Download document
        function downloadDocument(id) {
            window.open(`${DOC_API}/api/v1/documents/${id}/download`, '_blank');
        }

        // Edit document
        function editDocument(id) {
            alert('Doküman düzenleme yakında eklenecek...');
        }
    </script>
</body>
</html>